const diffType={mechanical:{id:"edit",ins:"INS",del:"DEL"},structural:{id:"structural",punctuation:"PUNCTUATION",textInsert:"TEXTINSERT",textDelete:"TEXTDELETE",wordchange:"WORDCHANGE",textReplace:"TEXTREPLACE",insert:"INSERT",delete:"DELETE",move:"MOVE",NOOP:"noop"},semantic:{id:"semantic"},newTextId:"new",oldTextId:"old"},algorithms={diffMatchPatch:"diff_match_patch"},regexp={punctuation:"^\\W[\\s]?[A-z]?$",wordchange:"^\\S*$",tagSelector:"<[.A-z]?[^(><.)]+>",unclosedTagSelector:"<[.A-z]?[^(><.)]+",unopenedTagSelector:"[.A-z]?[^(><.)]+>",textSelector:"[A-z\\s]*",lowercaseLetter:"[a-z]+",tagElements:"[<>/?]"},TBD="TBD",globalUser="SAURON";class DiffAlgorithmSelector{constructor(t,e,s){let i;switch(s){case algorithms.diffMatchPatch:i=new DiffMatchPatchAdapter(t,e);break;default:i=null}return i}}class Adapter{constructor(t,e){this.oldText=t,this.newText=e}makeDiff(t){this.threeDiff=new ThreeDiff(t,this.oldText,this.newText)}getMechanicalOperations(){return this.threeDiff.getMechanicalOperations()}getStructuralOperations(){return this.threeDiff.getStructuralOperations()}}class DiffMatchPatchAdapter extends Adapter{constructor(t,e){super(t,e);let s=new diff_match_patch;this.diffs=s.diff_main(t,e),s.diff_cleanupSemantic(this.diffs),this.patches=s.patch_make(this.diffs),this.runDiffAlgorithm()}runDiffAlgorithm(){this.makeDiff(this._getMechanicalOps())}_getMechanicalOps(){let t=[];for(let e of this.patches){let s=e.start1,i=e.diffs;i.map((e,n)=>{if(n>0){let t=i[n-1];-1!==t[0]&&(s+=parseInt(t[1].length))}if(0!==e[0]){let i=1===e[0]?diffType.mechanical.ins:diffType.mechanical.del;t.push(new MechanicalDiff(i,e[1],s,t.length))}})}return t}}class Diff{constructor(t,e){this.id=this._setId(t,e)}_setId(t,e){let s=`${t}-`,i=4-(++e).toString().length;for(;i>0;)s+="0",i--;return s+e}getText(t,e){return e}}class MechanicalDiff extends Diff{constructor(t,e,s,i){super(diffType.mechanical.id,i),this.op=t,this.content=e,this.pos=s}getWord(t){let e=t.substring(0,this.pos),s=t.substring(this.op===diffType.mechanical.ins?this.pos+this.content.length:this.pos,t.length);return e=e.split(/\s/)[e.split(/\s/).length-1],s=s.split(/\s/)[0],this.op===diffType.mechanical.ins&&(e+=this.content),e+s}getTag(t,e){let s=t.split(this.content),i=e.split(this.content),n={diff:this};return s.length>1?(n.left=s[0],n.right=s[1]):(n.left=i[0],n.right=i[1]),console.log(RegExp(regexp.unclosedTagSelector,"g").exec(n.left)),n}}class StructuralDiff extends Diff{constructor(t,e,s=globalUser){super(diffType.structural.id,t),this.op=TBD,this.by=s,this.timestamp=Date.now(),this.items=[e]}setOperation(t){this.op=t}addItem(t){this.items.push(t)}}class ThreeDiff{constructor(t,e,s){this.listMechanicalOperations=t,this.listStructuralOperations=[],this.listSemanticOperations=[],this.oldText=e,this.newText=s,this.structuralRules=[(t,e=null)=>{if(null===e)return!1;let s=t.getTag(this.newText,this.oldText),i=e.getTag(this.newText,this.oldText),n=s.left+s.diff.content+i.right,r=i.left+i.diff.content+i.right;return!(!RegExp(regexp.tagSelector).test(n)||!RegExp(regexp.tagSelector).test(r))&&(s.left===i.left&&s.right===i.right&&diffType.structural.NOOP)},(t,e=null)=>{if(null!==e)return!1;if(!RegExp(regexp.tagSelector).test(t.content))return!1;let s,i=[],n=RegExp(regexp.tagSelector,"g");for(;null!==(s=n.exec(t.content));)i.push(s[0]);if(i.length%2!=0)return!1;let r=i[0].replace(RegExp(regexp.tagElements,"g"),""),l=i[i.length-1].replace(RegExp(regexp.tagElements,"g"),"");if(r.split(/\s/)[0]!==l)return!1;let c=t.op===diffType.mechanical.ins?diffType.structural.insert:diffType.structural.delete;return!!RegExp(`^${regexp.textSelector}<${r}>.*</${l}>${regexp.textSelector}$`).test(t.content)&&c},(t,e=null)=>null!==e&&((!RegExp(regexp.tagSelector).test(t)||!RegExp(regexp.tagSelector).test(t))&&(!(!RegExp(regexp.punctuation).test(t.content)||!RegExp(regexp.punctuation).test(e.content)||t.pos!==e.pos||t.op===e.op)&&diffType.structural.punctuation)),(t,e=null)=>!1,(t,e=null)=>null!==e&&(t.content!==e.content&&t.pos===e.pos&&t.op!==e.op&&diffType.structural.textReplace),(t,e=null)=>{let s=t.getWord(this.newText);if(RegExp(regexp.tagSelector).test(t.content))return!1;if(null!=e){if(RegExp(regexp.tagSelector).test(e.content))return!1;let t=e.getWord(this.newText);return!(""===s||""===t||!RegExp(regexp.wordchange).test(s)||!RegExp(regexp.wordchange).test(t)||s!==t)&&diffType.structural.wordchange}return!(""===s||!RegExp(regexp.wordchange).test(s))&&diffType.structural.wordchange},(t,e=null)=>null===e&&(t.op===diffType.mechanical.ins?diffType.structural.textInsert:diffType.structural.textDelete)],this._executeStructuralAnalysis()}_executeStructuralAnalysis(){let t=this.listMechanicalOperations.slice(0);for(;t.length>0;){let e=!1,s=t.splice(0,1)[0],i=new StructuralDiff(this.listStructuralOperations.length,s);for(let n=0;n<t.length;n++){let r=t[n];for(let l of this.structuralRules){let c=l(s,r);if(this._checkRuleResulCorrectness(c)){i.setOperation(c),i.addItem(t.splice(n,1)[0]),e=!0,n--;break}}}if(!e)for(let t of this.structuralRules){let e=t(s);if(this._checkRuleResulCorrectness(e)){i.setOperation(e);break}}this.listStructuralOperations.push(i)}this._setOldsNews()}_setOldsNews(){for(let t of this.listStructuralOperations){let e=t.items,s=this._getContextBoundariesNew(this.newText,e[0],e[e.length-1]),i=s.leftContext;e.map((t,s)=>{let n=e[s+1];t.op===diffType.mechanical.ins?(i+=t.content,void 0!==n&&(i+=this.newText.substring(t.pos+t.content.length,n.pos))):void 0!==n&&(i+=this.newText.substring(t.pos,n.pos))}),i+=s.rightContext;let n=this._getContextBoundariesOld(this.oldText,e[0],e[e.length-1]).leftContext;e.map((t,s)=>{let i=e[s+1];t.op===diffType.mechanical.ins?void 0!==i&&(n+=this.oldText.substring(t.pos,i.pos-t.content.length)):(n+=t.content,void 0!==i&&(n+=this.oldText.substring(t.pos+t.content.length,i.pos+t.content.length)))}),n+=s.rightContext,t.new=i,t.old=n}}_getContextBoundariesNew(t,e,s){const i=e.pos,n=s.pos+(s.op===diffType.mechanical.ins?s.content.length:0),r=i<10?0:10,l=n+10<t.length?n+10:t.length;let c=t.substring(r,i).split(/\s/),o=t.substring(n,l).split(/\s/);return{leftContext:c[c.length-1],rightContext:o[0]}}_getContextBoundariesOld(t,e,s){const i=e.pos,n=s.pos+(s.op===diffType.mechanical.del?s.content.length:0),r=i<10?0:10,l=n+10<t.length?n+10:t.length;let c=t.substring(r,i).split(/\s/),o=t.substring(n,l).split(/\s/);return{leftContext:c[c.length-1],rightContext:o[0]}}_checkRuleResulCorrectness(t){return!1!==t&&(null!==t&&void 0!==t)}getMechanicalOperations(){return this.listMechanicalOperations}getStructuralOperations(){return this.listStructuralOperations}}